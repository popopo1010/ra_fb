# RA FB システム：問題点・改善レポート

> 2025-02 時点での分析（2026-02 更新）

---

## 実施した最適化

### 1. 共通モジュール化

- **RA名・会社名抽出**を `ra_fb/utils.py` に集約
- **load_env()** を `ra_fb/config.py` で一元管理（dotenv 優先、フォールバックで手動パース）

### 2. マーケットセグメント単一化

- `ra_fb/company.py` の重複定義を削除
- `references/candidate_attract/market_segments.py` を単一ソースに統一

### 3. トークン削減（FB生成リファレンス）

- **PSS_要点.md**（2k文字）、**架電マニュアル_要点.md**（2.7k文字）で要点版を使用
- **attract**: セクション5（法人別事例）を除外し、訴求軸・候補者タイプ×セグメントのみ
- **checklist** 削除（初回架電FBでは面談チェックリストの優先度が低い）
- 合計 約37k → 約12k 文字（約68%削減）

### 4. kadai に大城の課題整理を追加

- `小山田vs大城_課題整理.md` を kadai2 として FB 生成に反映

### 5. 例外処理の改善

- `logging` でエラーを記録（company.py, feedback.py, slack_server.py, webhook_server.py）
- 障害調査が容易に

### 6. API 未設定時の明示

- ANTHROPIC_API_KEY 未設定時、「※ ANTHROPIC_API_KEY が未設定です」と出力に表示

### 7. .env.example

- ルートに `.env.example` を用意済み

---

## 残存する問題点・注意点

### 高

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 1 | **file_shared の channel_id** | DM でファイル共有した場合、`channels` が空で ephemeral 通知が送れない | `file_shared` のペイロードを確認し、DM 用の channel 取得方法を検討 |
| 2 | **SLACK_WEBHOOK_URL 未設定時の挙動** | FB は生成されるが投稿されず、ユーザーに通知されない | 投稿失敗時に ephemeral で「投稿に失敗しました」を出す（channel が取れる場合） |

### 中

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 3 | **RA 追加時の修正箇所** | `ra_fb/utils.py` と `slack_server.py` のモーダル options が連動。新 RA 追加時に両方の更新が必要 | 追加時は両方更新。将来的に config から一元化を検討 |

### 低

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 4 | **generate_feedback の subprocess** | 後方互換スクリプトが毎回 Python プロセスを起動 | 必要になったら cli.py の関数呼び出しに変更 |

---

## ディレクトリ構成（現状）

```
RA_FBシステム/
├── ra_fb/                      # コアパッケージ
│   ├── config.py
│   ├── utils.py
│   ├── feedback.py
│   ├── slack.py
│   └── company.py
├── scripts/
│   ├── slack_server.py         # Slack /rafb_call /rafb_mtg
│   ├── webhook_server.py       # Notta × Zapier
│   ├── cli.py                  # RA/CA FB 生成 CLI
│   ├── compare_companies.py
│   ├── bulk_import_company.py
│   ├── update_playbook.py
│   ├── supplement_company_research.py
│   ├── migrate_company_master.py
│   ├── generate_feedback.py    # 後方互換
│   └── slack_app_server.py     # 後方互換
├── references/
│   ├── manual/                 # 架電マニュアル・PSS・要点版
│   └── candidate_attract/      # プレイブック・market_segments
├── data/
│   ├── input/ra/               # 初回架電文字起こし
│   └── input/ca/               # 法人面談議事録
├── docs/
└── requirements.txt
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-02-13 | 初版。最適化実施・問題点整理 |
| 2026-02-13 | マーケットセグメント単一化、トークン削減、kadai2追加、logging、API未設定明示、問題レポート更新 |
