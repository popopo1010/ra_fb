# RA FB システム：問題点・改善レポート

> 2025-02 時点での分析

---

## 実施した最適化

### 1. 共通モジュール化（`scripts/utils.py`）

- **RA名・会社名抽出**を `utils.py` に集約
- **RA_NAMES** 定数で一元管理（小山田・大城・茂野・重野）
- **load_env()** を共通化（dotenv 優先、フォールバックで手動パース）

### 2. 重複コードの削除

- `extract_ra_from_filename` / `extract_company_name` の重複を解消
- `_load_env` の重複実装を削除
- `threading` をトップレベルでインポート

### 3. Slack 長文対応

- `post_to_slack.py` に `_chunk_text()` を追加
- 3000 文字超の FB を複数ブロックに分割して投稿

### 4. 起動時チェック

- `SLACK_WEBHOOK_URL` 未設定時に警告を表示

---

## 残存する問題点・注意点

### 高

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 1 | **file_shared の channel_id** | DM でファイル共有した場合、`channels` が空で ephemeral 通知が送れない | `file_shared` のペイロードを確認し、DM 用の channel 取得方法を検討 |
| 2 | **SLACK_WEBHOOK_URL 未設定時の挙動** | FB は生成されるが投稿されず、ユーザーに通知されない | 投稿失敗時に ephemeral で「投稿に失敗しました」を出す（channel が取れる場合） |
| 3 | **kadai リファレンスが茂野vs小山田のみ** | 大城の課題整理が FB 生成に反映されない | `小山田vs大城_課題整理.md` を kadai に追加するか、RA に応じて切り替え |

### 中

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 4 | **例外の握りつぶし** | `except Exception: pass` が複数あり、障害調査が困難 | 最低限 `logging` でエラーを記録 |
| 5 | **ANTHROPIC_API_KEY 未設定時** | テンプレートのみ出力され、ユーザーに明示されない | 起動時または生成時に「API 未設定」と表示 |
| 6 | **リファレンスのトークン制限** | 合計約 35k で切り詰め。重要な文が欠落する可能性 | 優先度に応じた動的カット、または要約の検討 |

### 低

| # | 問題 | 影響 | 推奨対応 |
|---|------|------|----------|
| 7 | **RA 追加時の修正箇所** | `utils.RA_NAMES` とモーダル options が連動しているが、新 RA 追加時に両方の更新が必要 | 現状のままで運用し、追加時は両方更新 |
| 8 | **.env.example がない** | 初回セットアップ時に必要な変数が分かりにくい | `docs/` またはルートに `.env.example` を用意 |
| 9 | **generate_feedback の subprocess** | 毎回 Python プロセスを起動するためオーバーヘッドあり | 必要になったら関数呼び出しに変更 |

---

## ディレクトリ構成（再構築後）

```
RA_FBシステム/
├── ra_fb/                # コアパッケージ
│   ├── config.py
│   ├── utils.py
│   ├── feedback.py
│   └── slack.py
├── scripts/
│   ├── cli.py            # RA/CA FB 生成 CLI
│   ├── slack_server.py   # Slack /rafb /fb
│   ├── webhook_server.py # Notta × Zapier
│   ├── generate_feedback.py  # 後方互換
│   └── slack_app_server.py   # 後方互換
├── references/
├── docs/
└── requirements.txt
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-02-13 | 初版。最適化実施・問題点整理 |
